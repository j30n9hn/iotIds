############################################################
# LOCAL RULESET â€” IoT Hub / Grafana / MQTT / Web Security
############################################################

############################################################
# 1. PORT SCAN / RECONNAISSANCE DETECTION
############################################################
# 1
drop tcp $EXTERNAL_NET any -> $HUB any (
    msg:"PORTSCAN: TCP SYN";
    flags:S;
    flow:stateless;
    detection_filter:track by_src, count 20, seconds 3;
    sid:1000101; rev:2;
)

# 2
drop tcp $EXTERNAL_NET any -> $HUB any (
    msg:"PORTSCAN: TCP FIN";
    flags:F;
    flow:stateless;
    detection_filter:track by_src, count 15, seconds 3;
    sid:1000102; rev:2;
)

# 3
drop tcp $EXTERNAL_NET any -> $HUB any (
    msg:"PORTSCAN: TCP NULL";
    flags:0;
    flow:stateless;
    detection_filter:track by_src, count 15, seconds 3;
    sid:1000103; rev:2;
)

# 4
drop tcp $EXTERNAL_NET any -> $HUB any (
    msg:"PORTSCAN: TCP XMAS";
    flags:FPU;
    flow:stateless;
    detection_filter:track by_src, count 15, seconds 3;
    sid:1000104; rev:2;
)

# 5
drop udp $EXTERNAL_NET any -> $HUB any (
    msg:"PORTSCAN: UDP";
    flow:stateless;
    detection_filter:track by_src, count 20, seconds 5;
    sid:1000105; rev:2;
)

# 6
drop icmp $EXTERNAL_NET any -> $HUB any (
    msg:"PORTSCAN: ICMP sweep";
    itype:8;
    detection_filter:track by_src, count 10, seconds 3;
    sid:1000106; rev:2;
)

# 7
drop tcp $EXTERNAL_NET any -> $HUB [80,8080,3000] (
    msg:"PORTSCAN: Nmap HTTP probe";
    flow:to_server,established;
    content:"User-Agent|3a| Nmap"; http_header;
    sid:1000107; rev:2;
)

# 8
drop tcp $EXTERNAL_NET any -> $HUB 3000 (
    msg:"PORTSCAN: SYN to Grafana";
    flags:S;
    flow:stateless;
    detection_filter:track by_src, count 10, seconds 10;
    sid:1000108; rev:2;
)


############################################################
# 2. GRAFANA SECURITY
############################################################
# 9
drop tcp $EXTERNAL_NET any -> $HUB 3000 (
    msg:"GRAFANA: Brute force login";
    content:"POST"; http_method;
    content:"/login"; http_uri;
    detection_filter:track by_src, count 20, seconds 60;
    sid:1000109; rev:2;
)

# 10
drop http $EXTERNAL_NET any -> $HUB 3000 (
    msg:"GRAFANA: CVE-2021-43798 exploit";
    http_uri; content:"/public/plugins/";
    http_uri; content:"../";
    http_uri; content:"etc/passwd";
    sid:1000110; rev:2;
)

# 11
drop http $EXTERNAL_NET any -> $HUB 3000 (
   msg:"GRAFANA: Unauthorized API";
   http_uri; content:"/api/";
   sid:1000111; rev:2;
)

# 12
drop tcp $EXTERNAL_NET any -> $HUB [80,3000] (
    msg:"GRAFANA/WEB: DoS";
    detection_filter:track by_src, count 100, seconds 5;
    sid:1000112; rev:2;
)

# 13
drop http $EXTERNAL_NET any -> $HUB 3000 (
    msg:"GRAFANA: Config access";
    http_uri; content:"/conf/";
    sid:1000113; rev:2;
)


############################################################
# 3. IOT HUB SECURITY
############################################################
# 14
drop http $EXTERNAL_NET any -> $HUB 80 (
    msg:"IOT: Door control";
    http_uri; content:"/door/control";
    sid:1000114; rev:2;
)

# 15
drop http $EXTERNAL_NET any -> $HUB 80 (
    msg:"IOT: Door unlock cmd";
    http_client_body; content:"\"cmd\":\"open\"";
    sid:1000115; rev:2;
)

# 16
drop http $EXTERNAL_NET any -> $HUB 80 (
    msg:"IOT: Curtain control";
    http_uri; content:"/curtain/control";
    sid:1000116; rev:2;
)

# 17
drop http $EXTERNAL_NET any -> $HUB 80 (
    msg:"IOT: DELETE method";
    http_method; content:"DELETE";
    sid:1000117; rev:2;
)

# 18
drop http $EXTERNAL_NET any -> $HUB 80 (
    msg:"IOT: Directory Traversal";
    http_uri; content:"../";
    sid:1000118; rev:2;
)

# 19
drop http $EXTERNAL_NET any -> $HUB 80 (
    msg:"IOT: SQL Injection";
    content:"' OR '1'='1";
    sid:1000119; rev:2;
)

# 20
drop tcp $EXTERNAL_NET any -> $HUB 80 (
    msg:"IOT: DoS flood";
    detection_filter:track by_src, count 50, seconds 3;
    sid:1000120; rev:2;
)


############################################################
# 4. MQTT & INTERNAL SERVICES
############################################################
# 21
drop tcp $EXTERNAL_NET any -> $HUB 1883 (
    msg:"MQTT: Wildcard abuse";
    content:"#";
    sid:1000121; rev:2;
)

# 22
drop tcp $EXTERNAL_NET any -> $HUB 1883 (
    msg:"MQTT: Suspicious PUBLISH";
    content:"PUBLISH";
    sid:1000123; rev:1;
)

# 23
drop tcp $EXTERNAL_NET any -> $HUB [22,23,445] (
    msg:"INTERNAL SERVICE ACCESS";
    sid:1000122; rev:2;
)


############################################################
# 5. OWASP IoT ADVANCED ATTACK PATTERNS
############################################################
# 24
drop http $EXTERNAL_NET any -> $HUB 80 (
    msg:"IOT: Credential stuffing";
    http_uri; content:"/login";
    http_client_body; content:"password=";
    detection_filter:track by_src, count 20, seconds 60;
    sid:2000201; rev:1;
)

# 25
drop http $EXTERNAL_NET any -> $HUB 80 (
    msg:"IOT: Default credentials";
    http_client_body; content:"username=admin";
    http_client_body; content:"password=admin";
    sid:2000202; rev:1;
)

# 26
drop http $EXTERNAL_NET any -> $HUB 80 (
    msg:"IOT: Firmware update attempt";
    http_uri; content:"/firmware";
    http_method; content:"POST";
    sid:2000203; rev:1;
)

# 27
drop http $EXTERNAL_NET any -> $HUB 80 (
    msg:"IOT: OTA command injection";
    http_client_body; content:"cmd=";
    content:";";
    sid:2000204; rev:1;
)

# 28
drop http $EXTERNAL_NET any -> $HUB 80 (
    msg:"IOT: Malicious file upload";
    http_uri; content:"upload";
    content:".php";
    content:".sh";
    content:".exe";
    sid:2000205; rev:1;
)

# 29
drop http $EXTERNAL_NET any -> $HUB 80 (
    msg:"IOT: XXE Injection";
    http_client_body; content:"<!ENTITY";
    sid:2000206; rev:1;
)

# 30
drop http $EXTERNAL_NET any -> $HUB 80 (
    msg:"IOT: JSON prototype pollution";
    http_client_body; content:"__proto__";
    sid:2000207; rev:1;
)

# 31
drop http $EXTERNAL_NET any -> $HUB 80 (
    msg:"IOT: SSRF attempt";
    http_client_body; content:"http://127.0.0.1";
    http_client_body; content:"http://localhost";
    sid:2000208; rev:1;
)

# 32
drop tcp $EXTERNAL_NET any -> $HUB any (
    msg:"IOT: Buffer overflow signature";
    content:"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";
    sid:2000210; rev:1;
)


############################################################
# 6. COOKIE / SESSION SECURITY
############################################################
# 33
drop http $EXTERNAL_NET any -> $HUB 80 (
    msg:"IOT: Suspicious session reuse";
    http_cookie; content:"sessionid=";
    detection_filter:track by_src, count 5, seconds 10;
    sid:2000301; rev:1;
)

# 34
drop http $EXTERNAL_NET any -> $HUB 80 (
    msg:"IOT: Session fixation attempt";
    http_header; content:"Cookie: JSESSIONID=";
    pcre:"/JSESSIONID=[0-9a-f]{8,}/";
    sid:2000302; rev:1;
)

# 35
drop http $EXTERNAL_NET any -> $HUB 80 (
    msg:"IOT: Cookie tampering";
    http_cookie; content:"{";
    http_cookie; content:"}";
    sid:2000303; rev:1;
)

# 36
drop http $EXTERNAL_NET any -> $HUB 80 (
    msg:"IOT: Credentials in cookie";
    http_cookie; content:"password";
    sid:2000304; rev:1;
)

# 37
drop http $EXTERNAL_NET any -> $HUB 80 (
    msg:"IOT: JWT token reuse";
    http_header; content:"Authorization: Bearer ";
    detection_filter:track by_src, count 10, seconds 10;
    sid:2000305; rev:1;
)

# 38
drop http $EXTERNAL_NET any -> $HUB 80 (
    msg:"IOT: Missing CSRF token";
    http_method; content:"POST";
    pcre:"/Cookie:(?!.*csrftoken)/";
    sid:2000306; rev:1;
)

# 39
alert http any any -> any any (
    msg:"IOT: Insecure cookie attributes";
    http_header; content:"Set-Cookie";
    pcre:"/Set-Cookie:(?!.*(HttpOnly|Secure))/";
    sid:2000307; rev:1;
)
